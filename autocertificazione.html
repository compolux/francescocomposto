<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="./main.css" />
    <title>Autocertificazione</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
      input[type="text"], input[type="date"] {
        width: 100%;
        padding: 0.5em;
        margin: 0.5em 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: 'Lato', sans-serif;
      }
      .download-btn {
        padding: 0.5em 1em;
        background-color: var(--clr-footer);
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
        margin-top: 1rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 0.5em;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <nav>
      <div class="navbar-logo">
        <a href="/">caf composto milano</a>
      </div>
      <div class="navbar-item">
        <img style="padding-top: 0.2em; width: 1em" src="./graphics/resources/dot.svg" alt="dot" />
        <a href="#contact">contatti</a>
      </div>
    </nav>

    <section style="margin-top: 6rem; padding: 0 8%;" id="pdf-content">
      <h2>Dichiarazione Sostitutiva di Certificazione</h2>
      <div class="section-box">
        <label>Cognome e nome del dichiarante:</label><input id="nome" type="text" />
        <label>con cittadinanza:</label><input id="cittadinanza" type="text" />
        <label>nata/o a:</label><input id="luogo_nascita" type="text" />
        <label>il:</label><input id="data_nascita" type="date" />
        <label>Residente a:</label><input id="residenza" type="text" />
        <label>in via:</label><input id="via" type="text" />
        <label>nr:</label><input id="numero" type="text" />
        <label>Luogo e data:</label>
        <input id="luogo_data" type="text" />
        <p>Firma:</p>
        <canvas id="signature-pad" width="500" height="150" style="border:2px solid #2a2a2a;"></canvas>
        <div style="margin-top: 1rem;">
          <button class="download-btn" onclick="clearSignature()">Cancella firma</button>
          <label style="display:block; margin-top:0.5rem;"></label>
          <input type="file" id="uploadFirma" accept="image/*" onchange="loadUploadedSignature(event)" class="download-btn" style="margin-top:0.5rem;" />
        </div>
        <input type="hidden" id="firmaDigitale" />
      </div>

        <p>è consapevole che in caso di dichiarazione mendace sarà punito ai sensi del Codice Penale secondo quanto prescritto dall'art. 76 del succitato D.P.R. 445/2000 e che, inoltre, qualora dal controllo effettuato emerga la non veridicità del contenuto di taluna delle dichiarazioni rese, decadrà dai benefici conseguenti al provvedimento eventualmente emanato sulla base della dichiarazione non veritiera (art. 75 D.P.R. 445/2000).</p>

        <p>E' informato ed autorizza la raccolta dei dati per l'emanazione dei provvedimenti amministrativi ai sensi dell’art. 10 della L. 675/96.</p>

        <h3>DICHIARA</h3><br>
        <p>Che, <span style="background-color: #beac0d9a; font-size: 1.2rem;">in DATA ODIERNA</span>, il suo stato di famiglia è composto come risulta dal seguente prospetto ed è <span style="background-color: #beac0d9a; font-size: 1.2rem;">UGUALE a quello che è già stato dichiarato al Comune di residenza:</span></p>

        <table>
          <thead>
            <tr>
              <th>  nr.</th>
              <th>cognome e nome</th>
              <th>cittadinanza</th>
              <th>luogo di nascita</th>
              <th>data nascita</th>
              <th>rapporto parentela</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td><input type="text" /></td>
              <td>
                <select class="cittadinanza">
                  <option value="">-- Seleziona --</option>
                  <option value="Italiana">Italiana</option>
                  <option value="Estera">Estera</option>
                </select>
              </td>              
              <td><input type="text" /></td>
              <td><input type="date" /></td>
              <td>
                <select class="parentela">
                  <option value="">-- Seleziona --</option>
                  <option value="Coniuge">Coniuge</option>
                  <option value="Convivente">Convivente</option>
                  <option value="Figlia/o">Figlia/o</option>
                  <option value="Altro">Altro</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>2</td>
              <td><input type="text" /></td>
              <td>
                <select class="cittadinanza">
                  <option value="">-- Seleziona --</option>
                  <option value="Italiana">Italiana</option>
                  <option value="Estera">Estera</option>
                </select>
              </td>              
              <td><input type="text" /></td>
              <td><input type="date" /></td>
              <td>
                <select class="parentela">
                  <option value="">-- Seleziona --</option>
                  <option value="Coniuge">Coniuge</option>
                  <option value="Convivente">Convivente</option>
                  <option value="Figlia/o">Figlia/o</option>
                  <option value="Altro">Altro</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>3</td>
              <td><input type="text" /></td>
              <td>
                <select class="cittadinanza">
                  <option value="">-- Seleziona --</option>
                  <option value="Italiana">Italiana</option>
                  <option value="Estera">Estera</option>
                </select>
              </td>              
              <td><input type="text" /></td>
              <td><input type="date" /></td>
              <td>
                <select class="parentela">
                  <option value="">-- Seleziona --</option>
                  <option value="Coniuge">Coniuge</option>
                  <option value="Convivente">Convivente</option>
                  <option value="Figlia/o">Figlia/o</option>
                  <option value="Altro">Altro</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>4</td>
              <td><input type="text" /></td>
              <td>
                <select class="cittadinanza">
                  <option value="">-- Seleziona --</option>
                  <option value="Italiana">Italiana</option>
                  <option value="Estera">Estera</option>
                </select>
              </td>              
              <td><input type="text" /></td>
              <td><input type="date" /></td>
              <td>
                <select class="parentela">
                  <option value="">-- Seleziona --</option>
                  <option value="Coniuge">Coniuge</option>
                  <option value="Convivente">Convivente</option>
                  <option value="Figlia/o">Figlia/o</option>
                  <option value="Altro">Altro</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>5</td>
              <td><input type="text" /></td>
              <td>
                <select class="cittadinanza">
                  <option value="">-- Seleziona --</option>
                  <option value="Italiana">Italiana</option>
                  <option value="Estera">Estera</option>
                </select>
              </td>              
              <td><input type="text" /></td>
              <td><input type="date" /></td>
              <td>
                <select class="parentela">
                  <option value="">-- Seleziona --</option>
                  <option value="Coniuge">Coniuge</option>
                  <option value="Convivente">Convivente</option>
                  <option value="Figlia/o">Figlia/o</option>
                  <option value="Altro">Altro</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>6</td>
              <td><input type="text" /></td>
              <td>
                <select class="cittadinanza">
                  <option value="">-- Seleziona --</option>
                  <option value="Italiana">Italiana</option>
                  <option value="Estera">Estera</option>
                </select>
              </td>              
              <td><input type="text" /></td>
              <td><input type="date" /></td>
              <td>
                <select class="parentela">
                  <option value="">-- Seleziona --</option>
                  <option value="Coniuge">Coniuge</option>
                  <option value="Convivente">Convivente</option>
                  <option value="Figlia/o">Figlia/o</option>
                  <option value="Altro">Altro</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>7</td>
              <td><input type="text" /></td>
              <td>
                <select class="cittadinanza">
                  <option value="">-- Seleziona --</option>
                  <option value="Italiana">Italiana</option>
                  <option value="Estera">Estera</option>
                </select>
              </td>              
              <td><input type="text" /></td>
              <td><input type="date" /></td>
              <td>
                <select class="parentela">
                  <option value="">-- Seleziona --</option>
                  <option value="Coniuge">Coniuge</option>
                  <option value="Convivente">Convivente</option>
                  <option value="Figlia/o">Figlia/o</option>
                  <option value="Altro">Altro</option>
                </select>
              </td>
            </tr>
          </tbody>
          
        </table>

        <p style="margin-top: 2rem;">
          Esente da imposta di bollo ai sensi dell'art. 37 D.P.R. 445/2000<br />
          La presente dichiarazione ha validità per 6 mesi (art. 41 D.P.R. 445/2000);<br />
          se i documenti che sostituisce hanno validità maggiore ha la stessa validità di essi.<br />
          Tale dichiarazione può essere trasmessa via fax o con strumenti telematici (art. 38 D.P.R. 445/2000).<br />
          La mancata accettazione della presente dichiarazione costituisce violazione dei doveri d'ufficio (art.74 comma 1 D.P.R. 445/2000).
        </p>
      </div>

      <button class="download-btn" onclick="generatePDF()">Scarica il PDF</button>
    </section>

    <footer id="contact">
      <div style="margin-top: 1.5rem;"><h2>Contatti</h2></div>
      <div class="section-box" style="text-align: center; margin-bottom: 0.5rem;">
        <img style="margin-bottom: 1rem; width: 1.5em" src="./graphics/resources/dot.svg" alt="dot" />
        <p>mail: composto.servizicaf [at] gmail {dot} com</p>
      </div>
      <div class="section-box" style="text-align: center; margin-bottom: 0.5rem;">
        <img style="margin-bottom: 1rem; width: 1.5em" src="./graphics/resources/dot.svg" alt="dot" />
        <p>mobile: +39 335 61 68 758</p>
      </div>
    </footer>
    <footer id="footer_logo">
      <div style="margin-top: 2rem;"><p style="font-size: 0.8rem">twenty25 # Milano</p></div>
    </footer>

<!-- Script -->
<script>
  const canvas = document.getElementById("signature-pad");
  const ctx = canvas.getContext("2d");
  let drawing = false;
  
  canvas.addEventListener("mousedown", () => drawing = true);
  canvas.addEventListener("mouseup", () => { drawing = false; ctx.beginPath(); });
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("touchstart", () => drawing = true);
  canvas.addEventListener("touchend", () => { drawing = false; ctx.beginPath(); });
  canvas.addEventListener("touchmove", draw);
  
  document.getElementById('uploadFirma').addEventListener('change', loadUploadedSignature);
  
  function draw(e) {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "black";
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  }
  
  function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
  }
  
  function loadUploadedSignature(event) {
    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          const ratio = img.width / img.height;
          const maxHeight = 100;
          let newWidth = img.width;
          let newHeight = img.height;
  
          if (newHeight > maxHeight) {
            newHeight = maxHeight;
            newWidth = Math.round(maxHeight * ratio);
          }
  
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, newWidth, newHeight);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  }
  
  async function generatePDF() {
    const existingPdfBytes = await fetch("/2025_AUTOCERTIFICAZIONE.pdf").then(res => res.arrayBuffer());
    const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
    const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
    const page = pdfDoc.getPages()[0];
  
    const drawMain = (text, x, y) => page.drawText(text || '', { x, y, size: 8, font });
    const drawTable = (text, x, y) => page.drawText(text || '', { x, y, size: 6, font });
  
    drawMain((document.getElementById("nome").value || '').toUpperCase(), 150, 710);
    drawMain((document.getElementById("cittadinanza").value || '').toUpperCase(), 410, 710);
    drawMain((document.getElementById("luogo_nascita").value || '').toUpperCase(), 110, 687);
    drawMain(formatDateIT(document.getElementById("data_nascita").value), 350, 687);
    drawMain((document.getElementById("residenza").value || '').toUpperCase(), 120, 663);
    drawMain((document.getElementById("via").value || '').toUpperCase(), 330, 663);
    drawMain((document.getElementById("numero").value || '').toUpperCase(), 470, 663);
    drawMain((document.getElementById("luogo_data").value || '').toUpperCase(), 150, 200);
  
    const signatureUrl = canvas.toDataURL("image/png");
    const signatureImageBytes = await fetch(signatureUrl).then(res => res.arrayBuffer());
    const signatureImage = await pdfDoc.embedPng(signatureImageBytes);
  
    const signatureDims = signatureImage.scale(0.5);
    page.drawImage(signatureImage, {
      x: 300,
      y: 220,
      width: signatureDims.width,
      height: signatureDims.height
    });
  
    const rows = document.querySelectorAll("tbody tr");
    const startY = 465;
    const rowHeight = 22;
    rows.forEach((row, i) => {
      const inputs = row.querySelectorAll("input");
      const cittadinanzaSelect = row.querySelector("select.cittadinanza");
      const parentelaSelect = row.querySelector("select.parentela");
      const y = startY - i * rowHeight;
  
      drawTable((inputs[0].value || '').toUpperCase(), 80, y);
      drawTable((cittadinanzaSelect.value || '').toUpperCase(), 240, y);
      drawTable((inputs[1].value || '').toUpperCase(), 300, y);
      drawTable(formatDateIT(inputs[2].value), 390, y);
      drawTable((parentelaSelect.value || '').toUpperCase(), 470, y);
    });
  
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Autocertificazione_Compilata.pdf";
    link.click();
  }
  
  function formatDateIT(dateStr) {
    if (!dateStr) return '';
    const [year, month, day] = dateStr.split("-");
    return `${day}/${month}/${year}`;
  }
  </script>
  <script> //completamento automatico data
    window.addEventListener('DOMContentLoaded', () => {
      const oggi = new Date();
      const giorno = String(oggi.getDate()).padStart(2, '0');
      const mese = String(oggi.getMonth() + 1).padStart(2, '0');
      const anno = oggi.getFullYear();
      const dataFormattata = `, ${giorno}/${mese}/${anno}`;
  
      const luogoDataInput = document.getElementById('luogo_data');
      if (luogoDataInput && luogoDataInput.value.trim() === '') {
        luogoDataInput.value = dataFormattata;
        luogoDataInput.focus();
        luogoDataInput.setSelectionRange(0, 0); // Imposta il cursore prima della virgola
      }
    });
  </script>
  
  
    
  </body>
</html>
